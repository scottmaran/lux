# Feature Plan: Run-Scoped Logging Restructure

## Objective

Restructure logging so that each `lasso up` lifecycle writes to its own run directory, with service-level subdirectories and per-session/per-job timeline copies, while preserving the trust model and fixing log immutability drift.

This plan is implementation-focused and reflects current decisions already made.

## Confirmed Product Decisions

1. A new run directory starts at `lasso up` and ends at `lasso down`.
2. Hierarchy should be run-first.
3. Flat root log files should be removed (no backward path compatibility layer).
4. Each harness session/job should have its own filtered timeline copy.
5. Keep current filename conventions (including `.jsonl`).
6. New layout only; no migration for old logs.
7. Agent has read-only access to all historical logs under the configured log root.
8. `lasso up` while already running should fail with "already up" and should not restart.
9. Do not add new explicit permissive mode policy right now; keep current permission behavior.
10. `lasso logs tail` should default to the active run timeline.

## Target Log Layout

```text
<log_root>/
  lasso__YYYY_MM_DD_HH_MM_SS/
    collector/
      raw/
        audit.log
        ebpf.jsonl
      filtered/
        filtered_audit.jsonl
        filtered_ebpf.jsonl
        filtered_ebpf_summary.jsonl
        filtered_timeline.jsonl
    harness/
      sessions/
        <session_id>/
          meta.json
          stdin.log
          stdout.log
          filtered_timeline.jsonl
      jobs/
        <job_id>/
          input.json
          status.json
          stdout.log
          stderr.log
          filtered_timeline.jsonl
      labels/
        sessions/
        jobs/
```

## High-Level Design

1. Introduce a run identifier generated by `lasso up` (format: `lasso__YYYY_MM_DD_HH_MM_SS`).
2. Pass run identity into compose services via environment (`LASSO_RUN_ID`).
3. Repoint harness and collector outputs into run-scoped paths.
4. Keep a run-level merged timeline (`collector/filtered/filtered_timeline.jsonl`).
5. Generate per-session/per-job timeline copies under each harness artifact directory.
6. Reintroduce agent immutability hardening from `log_immutability_controls`:
   - `cap_drop: [SYS_ADMIN]`
   - `security_opt: [no-new-privileges:true]`
7. Update CLI, UI/API, tests, and docs to consume run-scoped paths.

## Workstreams

### 1) Run Identity and Lifecycle

1. Add run ID generation in `lasso up`.
2. Detect already-running stack and fail early with "already up".
3. Persist active run metadata (lightweight run-state file in config dir) so `logs`/`jobs` commands can resolve active run.
4. Resolve active run from compose state first, then run-state file (avoid stale-state false positives).
5. Clear or rotate active run state on `lasso down`.

### 2) Compose and Runtime Wiring

1. Add `LASSO_RUN_ID` propagation in CLI compose invocation (runtime env injection per `up/status/down/tui/run` lifecycle, not static config).
2. Reintroduce immutability controls for agent service in `compose.yml`.
3. Keep existing mount topology (same root mount), but use run/service subpaths for outputs.

### 3) Harness Output Repathing

1. Change harness base directories from `/logs/{sessions,jobs,labels}` to run-scoped paths:
   - `/logs/$LASSO_RUN_ID/harness/sessions`
   - `/logs/$LASSO_RUN_ID/harness/jobs`
   - `/logs/$LASSO_RUN_ID/harness/labels/{sessions,jobs}`
2. Ensure session/job artifact writes remain atomic and attribution metadata unchanged.

### 4) Collector Output Repathing

1. Repoint collector outputs:
   - raw logs -> `/logs/$LASSO_RUN_ID/collector/raw/*`
   - filtered logs -> `/logs/$LASSO_RUN_ID/collector/filtered/*`
2. Update collector config defaults and environment wiring accordingly.
3. Ensure follow loops and rotation logic still behave correctly under new paths.

### 5) Per-Session and Per-Job Timeline Copies

1. Keep run-level aggregate timeline as collector source of truth.
2. Add per-session/per-job filtered timeline file materialization:
   - session copy contains only rows where `session_id == <session_id>`
   - job copy contains only rows where `job_id == <job_id>`
3. Trigger copy updates at session/job completion and on-demand reconciliation pass to avoid races.

### 6) CLI Path and Command Behavior

1. Update `lasso logs tail` default target to active run timeline:
   - `<log_root>/<active_run>/collector/filtered/filtered_timeline.jsonl`
2. Update `lasso logs stats` to aggregate by run-scoped session dirs.
3. Update `lasso jobs list/get` to read active run job directory by default.
4. Add clear error when no active run exists for default `logs` queries.
5. Add run-selection options for non-active inspection:
   - `--run-id <id>` and `--latest` for `logs tail` and `jobs list/get`.

### 7) UI/API Compatibility

1. Update UI server path resolution to run-scoped data.
2. Ensure sessions/jobs/timeline/summary endpoints read from active run by default.
3. Keep label behavior under run-scoped harness labels directory.
4. Add run selection support (`run_id` query) for browsing historical runs.

### 8) Test Infrastructure and Fixtures

1. Update integration stack helpers to resolve run directory and new artifact paths.
2. Update CLI shell suite expectations for run-scoped paths.
3. Update timeline validators and helper loaders that assume flat root structure.

## Acceptance Criteria

1. No new run writes any collector or harness artifacts directly under `<log_root>/` flat paths.
2. Each `lasso up` creates exactly one run directory.
3. All logs for that lifecycle are confined to that run directory.
4. Agent can read all historical logs read-only.
5. `lasso up` fails if stack already running and does not restart services.
6. Run-level timeline exists and updates during runtime.
7. Session/job-level filtered timeline copies exist after completion and contain correctly scoped rows.
8. Immutability controls are present in compose and covered by tests.
9. CLI and UI can inspect non-active runs via explicit run selection.

## Test Plan (Add/Update)

### Unit Tests to Update

1. `tests/unit/test_compose_contract_parity.py`
   - add checks for agent `cap_drop: SYS_ADMIN`
   - add checks for agent `security_opt: no-new-privileges:true`
2. `tests/unit/test_timeline_validator.py`
   - adjust expected path model to run-scoped directories
3. `lasso/tests/cli.rs`
   - update `logs`/`jobs` behavior and active-run resolution assertions

### Integration Tests to Update

1. `tests/integration/test_job_lifecycle_artifacts.py`
2. `tests/integration/test_agent_codex_tui.py`
3. `tests/integration/test_agent_codex_cli_tui.py`
4. `tests/integration/test_filter_and_merge_behavior.py`
5. `tests/integration/test_cli_script_suite.py`
6. `scripts/cli_scripts/10_stack_smoke.sh`
   - replace flat path assertions with run-scoped assertions

### New Tests to Add

1. Integration: run directory creation and service subtree presence on `lasso up`.
2. Integration: no flat root files written during active run.
3. Integration: per-session timeline copy exists and is correctly filtered.
4. Integration: per-job timeline copy exists and is correctly filtered.
5. CLI integration/regression: second `lasso up` fails with "already up" and no restart side effects.
6. CLI integration: `lasso logs tail` defaults to active run timeline path.
7. CLI integration: default `logs tail` fails with explicit "no active run" when stack is down.
8. CLI integration: `logs`/`jobs` with `--run-id` and `--latest` work for historical runs.

### Regression Coverage

1. Preserve existing startup permission regression behavior.
2. Add regression guard to ensure immutability controls are not removed again.

## Documentation Plan (Add/Update)

### Update Existing Docs

1. `README.md`
   - update high-level logging structure and examples
2. `docs/guide/cli.md`
   - update `up` already-running behavior
   - update `logs tail/stats` run-scoped behavior
3. `docs/guide/config.md`
   - clarify log root now contains run directories
4. `docs/dev/EXAMPLE_FLOW.md`
   - replace flat log examples with run-scoped examples
5. `docs/vm/lasso_vm_layout.md`
   - reflect run/service subtree layout and role-based write boundaries
6. `docs/ui/UI_API.md`
   - update API path semantics with active-run default + `run_id` selection
7. `harness/README.md`
   - update artifact locations
8. `collector/README.md`
   - update raw/filtered output paths
9. `docs/history/HISTORY.md`
   - add phase entry describing run-scoped logging redesign
10. `docs/history/dev_log.md`
   - add implementation block for this feature

### New Documentation (If Needed)

1. Optional short run-layout reference doc under `docs/guide/` if README sections become too dense.
   - `docs/guide/log_layout.md`: run directory naming, tree, active-vs-historical behavior, and quick inspection commands.

## Risks and Mitigations

1. Risk: path drift across harness/collector/UI/CLI.
   - Mitigation: centralize run path helpers and add integration assertions.
2. Risk: race when writing per-session/job timeline copies.
   - Mitigation: completion-time materialization plus reconciliation pass.
3. Risk: tests silently still reading flat paths.
   - Mitigation: explicit "no flat paths" integration test.
4. Risk: immutability controls re-removed in future merges.
   - Mitigation: compose contract unit test plus changelog entry.

## Implementation Order

1. Compose + CLI run identity + already-up guard.
2. Harness/collector path repathing and run-level timeline stability.
3. Session/job timeline copy generation.
4. UI/API adaptation.
5. Test updates + new tests.
6. Documentation updates.
7. Full suite validation.

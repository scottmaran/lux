name: ci-stress

on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * *"

permissions:
  contents: read

jobs:
  stress-full:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Sync dependencies
        run: uv sync --frozen

      - name: Stress full
        run: uv run python scripts/all_tests.py stress-full

  agent-codex-exec-real:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Sync dependencies
        run: uv sync --frozen

      - name: Require real codex auth secret
        env:
          CODEX_AUTH_JSON: ${{ secrets.CODEX_AUTH_JSON }}
        run: |
          if [ -z "${CODEX_AUTH_JSON}" ]; then
            echo "Missing required secret CODEX_AUTH_JSON"
            exit 1
          fi

      - name: Prepare codex credentials
        env:
          CODEX_AUTH_JSON: ${{ secrets.CODEX_AUTH_JSON }}
        run: |
          mkdir -p "$HOME/.codex/skills"
          printf '%s' "$CODEX_AUTH_JSON" > "$HOME/.codex/auth.json"
          chmod 600 "$HOME/.codex/auth.json"

      - name: Agent codex exec (real)
        run: uv run python scripts/all_tests.py agent-codex-exec --real-codex

  agent-codex-tui-real:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Sync dependencies
        run: uv sync --frozen

      - name: Require real codex auth secret
        env:
          CODEX_AUTH_JSON: ${{ secrets.CODEX_AUTH_JSON }}
        run: |
          if [ -z "${CODEX_AUTH_JSON}" ]; then
            echo "Missing required secret CODEX_AUTH_JSON"
            exit 1
          fi

      - name: Prepare codex credentials
        env:
          CODEX_AUTH_JSON: ${{ secrets.CODEX_AUTH_JSON }}
        run: |
          mkdir -p "$HOME/.codex/skills"
          printf '%s' "$CODEX_AUTH_JSON" > "$HOME/.codex/auth.json"
          chmod 600 "$HOME/.codex/auth.json"

      - name: Agent codex tui (real)
        run: uv run python scripts/all_tests.py agent-codex-tui --real-codex

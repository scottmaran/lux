name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. v0.1.0)"
        required: true
      push_images:
        description: "Build and push GHCR images"
        required: true
        default: "true"
      publish_release:
        description: "Create GitHub Release + upload bundles"
        required: true
        default: "true"

permissions:
  contents: write
  packages: write

jobs:
  build-cli:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: linux
            arch: amd64
            runner: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: linux
            arch: arm64
            runner: ubuntu-latest
          - target: x86_64-apple-darwin
            os: darwin
            arch: amd64
            runner: macos-14
          - target: aarch64-apple-darwin
            os: darwin
            arch: arm64
            runner: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version
        run: echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross toolchain (linux targets)
        if: startsWith(matrix.target, 'aarch64-unknown-linux-gnu')
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Configure cross-linker (linux arm64)
        if: startsWith(matrix.target, 'aarch64-unknown-linux-gnu')
        run: |
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_AR=aarch64-linux-gnu-ar" >> $GITHUB_ENV

      - name: Build CLI
        run: |
          cargo build --release --target ${{ matrix.target }}
        working-directory: lasso

      - name: Assemble bundle
        run: |
          VERSION_TAG=${VERSION#v}
          BUNDLE_DIR=dist/lasso_${VERSION_TAG}_${{ matrix.os }}_${{ matrix.arch }}
          mkdir -p "$BUNDLE_DIR/config"
          cp lasso/target/${{ matrix.target }}/release/lasso "$BUNDLE_DIR/"
          cp compose.yml "$BUNDLE_DIR/"
          cp compose.codex.yml "$BUNDLE_DIR/"
          cp compose.ui.yml "$BUNDLE_DIR/"
          cp lasso/config/default.yaml "$BUNDLE_DIR/config/default.yaml"
          cp README.md "$BUNDLE_DIR/README.md"
          if [ -f LICENSE ]; then cp LICENSE "$BUNDLE_DIR/LICENSE"; fi
          echo "${VERSION#v}" > "$BUNDLE_DIR/VERSION"
          (cd dist && tar -czf lasso_${VERSION_TAG}_${{ matrix.os }}_${{ matrix.arch }}.tar.gz "$(basename "$BUNDLE_DIR")")
          (cd dist && if command -v shasum >/dev/null 2>&1; then shasum -a 256 lasso_${VERSION_TAG}_${{ matrix.os }}_${{ matrix.arch }}.tar.gz; else sha256sum lasso_${VERSION_TAG}_${{ matrix.os }}_${{ matrix.arch }}.tar.gz; fi > lasso_${VERSION_TAG}_${{ matrix.os }}_${{ matrix.arch }}.tar.gz.sha256)

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: lasso-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/*.tar.gz*

  build-images:
    runs-on: ubuntu-latest
    if: ${{ inputs.push_images == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version
        run: echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push images
        run: |
          VERSION_TAG=${VERSION#v}
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t ghcr.io/${{ github.repository_owner }}/lasso-agent:${VERSION} \
            -t ghcr.io/${{ github.repository_owner }}/lasso-agent:${VERSION_TAG} \
            -f agent/Dockerfile --push .
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t ghcr.io/${{ github.repository_owner }}/lasso-harness:${VERSION} \
            -t ghcr.io/${{ github.repository_owner }}/lasso-harness:${VERSION_TAG} \
            -f harness/Dockerfile --push .
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t ghcr.io/${{ github.repository_owner }}/lasso-collector:${VERSION} \
            -t ghcr.io/${{ github.repository_owner }}/lasso-collector:${VERSION_TAG} \
            -f collector/Dockerfile --push .
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t ghcr.io/${{ github.repository_owner }}/lasso-ui:${VERSION} \
            -t ghcr.io/${{ github.repository_owner }}/lasso-ui:${VERSION_TAG} \
            -f ui/Dockerfile --push .

  publish-release:
    runs-on: ubuntu-latest
    if: ${{ inputs.publish_release == 'true' }}
    needs: build-cli
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: ${{ inputs.version }}
          files: dist/**/*

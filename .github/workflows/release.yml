name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. v0.1.0)"
        required: true
      push_images:
        description: "Build and push GHCR images"
        required: true
        type: choice
        options:
          - "true"
          - "false"
        default: "true"
      publish_release:
        description: "Create GitHub Release + upload bundles"
        required: true
        type: choice
        options:
          - "true"
          - "false"
        default: "true"
      draft:
        description: "Create GitHub Release as a draft"
        required: true
        type: choice
        options:
          - "false"
          - "true"
        default: "false"
      prerelease:
        description: "Mark GitHub Release as a prerelease (not returned by /releases/latest)"
        required: true
        type: choice
        options:
          - "false"
          - "true"
        default: "false"
      allow_existing_tag:
        description: "Allow rerun if the git tag already exists (tag must point at this workflow commit)"
        required: true
        type: choice
        options:
          - "false"
          - "true"
        default: "false"

concurrency:
  group: release-${{ inputs.version }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write

jobs:
  verify-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify workflow inputs and repo versions
        run: |
          set -euo pipefail
          VERSION="${{ inputs.version }}"
          PUSH_IMAGES="${{ inputs.push_images }}"
          PUBLISH_RELEASE="${{ inputs.publish_release }}"
          ALLOW_EXISTING_TAG="${{ inputs.allow_existing_tag }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "release version must match vX.Y.Z (got: $VERSION)" >&2
            exit 1
          fi

          if [[ "$PUBLISH_RELEASE" == "true" && "$PUSH_IMAGES" != "true" ]]; then
            echo "publish_release=true requires push_images=true" >&2
            exit 1
          fi

          EXPECTED="${VERSION#v}"
          CARGO_VERSION=$(sed -n 's/^version = "\(.*\)"/\1/p' lux/Cargo.toml | head -n 1)
          LOCK_VERSION=$(awk 'f && /^version = /{gsub(/version = "|"/,"");print;exit} /^name = "lux"$/{f=1}' lux/Cargo.lock)
          PYPROJECT_VERSION=$(sed -n 's/^version = "\(.*\)"/\1/p' pyproject.toml | head -n 1)

          echo "release input:  $VERSION"
          echo "cargo version:  $CARGO_VERSION"
          echo "cargo.lock ver: $LOCK_VERSION"
          echo "pyproject ver:  $PYPROJECT_VERSION"

          if [[ "$CARGO_VERSION" != "$EXPECTED" ]]; then
            echo "lux/Cargo.toml version ($CARGO_VERSION) must equal $EXPECTED" >&2
            exit 1
          fi

          if [[ "$LOCK_VERSION" != "$EXPECTED" ]]; then
            echo "lux/Cargo.lock package version ($LOCK_VERSION) must equal $EXPECTED" >&2
            exit 1
          fi

          if [[ "$PYPROJECT_VERSION" != "$EXPECTED" ]]; then
            echo "pyproject.toml version ($PYPROJECT_VERSION) must equal $EXPECTED" >&2
            exit 1
          fi

          if git ls-remote --exit-code --tags origin "refs/tags/${VERSION}" >/dev/null 2>&1; then
            echo "tag exists: ${VERSION}"
            git fetch --force --depth=1 origin "refs/tags/${VERSION}:refs/tags/${VERSION}"
            TAG_SHA=$(git rev-parse "${VERSION}^{commit}")
            echo "tag commit: $TAG_SHA"
            echo "run commit: ${{ github.sha }}"
            if [[ "$TAG_SHA" != "${{ github.sha }}" ]]; then
              echo "tag ${VERSION} points to ${TAG_SHA}, expected ${{ github.sha }}" >&2
              exit 1
            fi
            if [[ "$ALLOW_EXISTING_TAG" != "true" ]]; then
              echo "tag ${VERSION} already exists; rerun requires allow_existing_tag=true" >&2
              exit 1
            fi
          fi

  build-cli:
    needs: verify-version
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: linux
            arch: amd64
            runner: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: linux
            arch: arm64
            runner: ubuntu-latest
          - target: x86_64-apple-darwin
            os: darwin
            arch: amd64
            runner: macos-14
          - target: aarch64-apple-darwin
            os: darwin
            arch: arm64
            runner: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version
        run: echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross toolchain (linux targets)
        if: startsWith(matrix.target, 'aarch64-unknown-linux-gnu')
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Configure cross-linker (linux arm64)
        if: startsWith(matrix.target, 'aarch64-unknown-linux-gnu')
        run: |
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_AR=aarch64-linux-gnu-ar" >> $GITHUB_ENV

      - name: Build CLI
        run: |
          cargo build --release --locked --target ${{ matrix.target }}
        working-directory: lux

      - name: Assemble bundle
        run: |
          set -euo pipefail
          VERSION_TAG=${VERSION#v}
          BUNDLE_DIR=dist/lux_${VERSION_TAG}_${{ matrix.os }}_${{ matrix.arch }}
          mkdir -p "$BUNDLE_DIR/config"
          cp lux/target/${{ matrix.target }}/release/lux "$BUNDLE_DIR/"
          cp compose.yml "$BUNDLE_DIR/"
          cp compose.ui.yml "$BUNDLE_DIR/"
          cp lux/config/default.yaml "$BUNDLE_DIR/config/default.yaml"
          mkdir -p "$BUNDLE_DIR/docs/contracts"
          cp docs/contracts/cli.md "$BUNDLE_DIR/docs/contracts/cli.md"
          cp docs/contracts/config.md "$BUNDLE_DIR/docs/contracts/config.md"
          cp README.md "$BUNDLE_DIR/README.md"
          if [ -f LICENSE ]; then cp LICENSE "$BUNDLE_DIR/LICENSE"; fi
          echo "${VERSION#v}" > "$BUNDLE_DIR/VERSION"
          (cd dist && tar -czf lux_${VERSION_TAG}_${{ matrix.os }}_${{ matrix.arch }}.tar.gz "$(basename "$BUNDLE_DIR")")
          (cd dist && if command -v shasum >/dev/null 2>&1; then shasum -a 256 lux_${VERSION_TAG}_${{ matrix.os }}_${{ matrix.arch }}.tar.gz; else sha256sum lux_${VERSION_TAG}_${{ matrix.os }}_${{ matrix.arch }}.tar.gz; fi > lux_${VERSION_TAG}_${{ matrix.os }}_${{ matrix.arch }}.tar.gz.sha256)

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: lux-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/*.tar.gz*

  build-images:
    needs: build-cli
    runs-on: ubuntu-latest
    if: ${{ inputs.push_images == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version
        run: echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push images
        run: |
          set -euo pipefail
          VERSION_TAG=${VERSION#v}
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t ghcr.io/${{ github.repository_owner }}/lux-agent:${VERSION} \
            -t ghcr.io/${{ github.repository_owner }}/lux-agent:${VERSION_TAG} \
            -f agent/Dockerfile --push agent
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t ghcr.io/${{ github.repository_owner }}/lux-harness:${VERSION} \
            -t ghcr.io/${{ github.repository_owner }}/lux-harness:${VERSION_TAG} \
            -f harness/Dockerfile --push harness
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t ghcr.io/${{ github.repository_owner }}/lux-collector:${VERSION} \
            -t ghcr.io/${{ github.repository_owner }}/lux-collector:${VERSION_TAG} \
            -f collector/Dockerfile --push collector
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t ghcr.io/${{ github.repository_owner }}/lux-ui:${VERSION} \
            -t ghcr.io/${{ github.repository_owner }}/lux-ui:${VERSION_TAG} \
            -f ui/Dockerfile --push ui

  publish-release:
    runs-on: ubuntu-latest
    if: ${{ inputs.publish_release == 'true' }}
    needs: [build-cli, build-images]
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: ${{ inputs.version }}
          target_commitish: ${{ github.sha }}
          draft: ${{ inputs.draft }}
          prerelease: ${{ inputs.prerelease }}
          fail_on_unmatched_files: true
          files: |
            dist/**/*.tar.gz
            dist/**/*.tar.gz.sha256

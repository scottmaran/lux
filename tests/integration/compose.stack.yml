services:
  collector:
    build:
      context: ../../collector
      dockerfile: Dockerfile
    image: lasso-test-collector:local
    privileged: true
    pid: "host"
    volumes:
      - ${LASSO_LOG_ROOT}:/logs:rw
      - ${LASSO_WORKSPACE_ROOT}:/work:ro
      - /sys/fs/bpf:/sys/fs/bpf:rw
      - /sys/kernel/tracing:/sys/kernel/tracing:rw
      - /sys/kernel/debug:/sys/kernel/debug:rw
    environment:
      - COLLECTOR_AUDIT_LOG=/logs/audit.log
      - COLLECTOR_EBPF_OUTPUT=/logs/ebpf.jsonl

  agent:
    build:
      context: ../../agent
      dockerfile: Dockerfile
    image: lasso-test-agent:local
    volumes:
      - ${LASSO_WORKSPACE_ROOT}:/work:rw
      - ${LASSO_LOG_ROOT}:/logs:ro
      - harness_keys:/config:ro

  harness:
    build:
      context: ../../harness
      dockerfile: Dockerfile
    image: lasso-test-harness:local
    volumes:
      - ${LASSO_WORKSPACE_ROOT}:/work:rw
      - ${LASSO_LOG_ROOT}:/logs:rw
      - harness_keys:/harness/keys:rw
    ports:
      - "127.0.0.1:${HARNESS_HOST_PORT:-18081}:8081"
    environment:
      - HARNESS_AGENT_HOST=agent
      - HARNESS_AGENT_PORT=22
      - HARNESS_AGENT_USER=agent
      - HARNESS_HTTP_BIND=0.0.0.0
      - HARNESS_HTTP_PORT=8081
      - HARNESS_API_TOKEN=${HARNESS_API_TOKEN:-dev-token}
      - HARNESS_AGENT_WORKDIR=/work
      - HARNESS_RUN_CMD_TEMPLATE=${HARNESS_RUN_CMD_TEMPLATE:-bash -lc {prompt}}
    depends_on:
      - agent

volumes:
  harness_keys:
